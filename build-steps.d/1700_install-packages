#!/bin/bash

## Copyright (C) 2012 - 2022 ENCRYPTED SUPPORT LP <adrelanos@whonix.org>
## See the file COPYING for copying conditions.

set -x
set -e

true "INFO: Currently running script: $BASH_SOURCE $@"

MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

cd "$MYDIR"
cd ..
cd help-steps

source pre
source colors
source variables

root_check

## Debugging function.
apt_get_parse_unmet_dependency() {
   local pkg_unmet
   pkg_unmet="$1"
   true "INFO: Running \"dpkg -l | grep $pkg_unmet\"..."
   $CHROOT dpkg -l | grep "$pkg_unmet" || true
   $CHROOT apt-cache policy "$pkg_unmet" || true

   local line

   ## Thanks to:
   ## http://blog.edwards-research.com/2010/01/quick-bash-trick-looping-through-output-lines/

   set +x

   declare -A -g remember_pkg

   while read -r -d $'\n' line; do
      local unmet_dependency=""
      unmet_dependency="$(echo "$line" | grep -o "Depends:.*" | awk '{print $2}')" || true
      if [ "$unmet_dependency" = "" ]; then
         ## no match
         continue
      else
         ## match
         if [ "${remember_pkg[$unmet_dependency]}" = "true" ]; then
            continue
         fi
         echo "${bold}${cyan}INFO: Found unmet dependency: $unmet_dependency. \
Will try to manually install it for debugging...${reset}"
         remember_pkg[$unmet_dependency]="true"
         set -x
         true "INFO: Running \"dpkg -l | grep $unmet_dependency\"..."
         $CHROOT dpkg -l | grep "$unmet_dependency" || true
         $CHROOT apt-cache policy "$unmet_dependency" || true
         pkg-install "$unmet_dependency" || true
         set +x
         echo "${bold}${cyan}INFO: Attempt to install unmet_dependency: $unmet_dependency done.${reset}"
         continue
      fi
   done < <( echo "$apt_get_output" )

   set -x
}

pkg-install() {
   errorhandlersetup "errorhandlerunchrootunpreventunmount" ERR INT TERM

   local pkg_install_item
   pkg_install_item="$1"
   local skip_package
   for skip_package in $dist_build_script_skip_package_install; do
      if [ "$skip_package" = "$pkg_install_item" ]; then
         unset skip_package
         true "${bold}${cyan}INFO: Skipping installation of '$pkg_install_item', because variable dist_build_script_skip_package_install includes it.${reset}"
         return 0
      fi
   done
   unset skip_package

   true "${cyan}INFO: Installing of '$@', because variable dist_build_script_skip_package_install does not include it... \
This may take a while...${reset}"

   ## apt: no way to view dpkg commandline and still run dpkg
   ## https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=52670
   local apt_get_exit_code="0"
   $CHROOT \
      apt-get \
         ${APTGETOPT[@]} \
         $apt_sourcelist_empty \
         $apt_sourceparts \
         $apt_unattended_opts \
         --yes \
         --no-install-recommends \
         install \
         "$@" \
         || { apt_get_exit_code="$?" ; true; };

   local apt_get_exit_code="0"
   $CHROOT \
      apt-get \
         ${APTGETOPT[@]} \
         $apt_sourcelist_empty \
         $apt_sourceparts \
         $apt_unattended_opts \
         --yes \
         --no-install-recommends \
         install \
         "$@" \
         || { apt_get_exit_code="$?" ; true; };

   $CHROOT sync
   sync

   if [ "$apt_get_exit_code" = "0" ]; then
      true "${cyan}INFO: Installed '$@', no error detected.${reset}"
      return 0
   fi

   true "${bold}${red}ERROR: Failed to install '$@'. (apt_get_exit_code: $apt_get_exit_code) \
Attempting to gather debug output to diagnose the problem...${reset}"

   true "${bold}${cyan}INFO: Read output of apt-get trying to install '$@' into a \
variable for debugging. This may take a while...${reset}"

   local apt_get_exit_code="0"
   apt_get_output=" \
         $( \
            $CHROOT \
               apt-get \
                  ${APTGETOPT[@]} \
                  $apt_sourcelist_empty \
                  $apt_sourceparts \
                  $apt_unattended_opts \
                  --yes \
                  --no-install-recommends \
                  install \
                  "$@" \
                  2>&1 \
         ) \
      " \
      || { apt_get_exit_code="$?" ; true; };

   $CHROOT sync
   sync

   if [ "$apt_get_exit_code" = "0" ]; then
      true "${bold}${red}ERROR: Second attempt installing '$@' did not fail?!?${reset}"
      error "See above!"
      return 0
   fi

   true "${bold}${red}ERROR: As expected, failed again to install '$@'. (apt_get_exit_code: $apt_get_exit_code) \
Trying to diagnose the problem using function apt_get_parse_unmet_dependency...${reset}"

   apt_get_parse_unmet_dependency "$@"

   true "INFO: Tried to diagnose the problem using function apt_get_parse_unmet_dependency."

   error "See above!"
   return 0
}

pkg-add-to-install-list() {
   errorhandlersetup "errorhandlerunchrootunpreventunmount" ERR INT TERM

   local pkg_install_item
   pkg_install_item="$1"
   local skip_package
   for skip_package in $dist_build_script_skip_package_install; do
      if [ "$skip_package" = "$pkg_install_item" ]; then
         unset skip_package
         true "${bold}${cyan}INFO: Skipping package $pkg_install_item, because dist_build_script_skip_package_install includes it.${reset}"
         return 0
      fi
   done
   unset skip_package

   if [ "$pkg_install_debug" = "true" ]; then
      pkg-install "$pkg_install_item"
   else
      pkg_install_list+=" $pkg_install_item "
   fi
}

pkg-list-install() {
   errorhandlersetup "errorhandlerunchrootunpreventunmount" ERR INT TERM

   if [ "$pkg_install_list" = "" ]; then
      true "INFO: pkg_install_list still empty, ok."
      return 0
   else
      pkg-install $pkg_install_list
   fi
}

install-packages() {
   errorhandlersetup "errorhandlerunchrootunpreventunmount" ERR INT TERM

   sync

   "$dist_source_help_steps_folder/mount-raw"
   "$dist_source_help_steps_folder/prevent-daemons-from-starting"

   sync

   ## Sanity tests.
   $CHROOT sync

   sync

   "$dist_source_help_steps_folder/create-local-temp-apt-repo"
   "$dist_source_help_steps_folder/chroot-raw"

   ## Debugging.
   $CHROOT ls -la /mnt/initialdeb/dists/local/ || true
   $CHROOT ls -la /mnt/initialdeb/dists/local/main/binary-*/ || true

   $CHROOT apt-get ${APTGETOPT[@]} $apt_sourcelist_empty $apt_sourceparts $apt_unattended_opts update

   "$dist_source_help_steps_folder/unchroot-raw"

   ## {{ controversy of: /etc/resolv.conf /etc/hosts /etc/hostname,
   ##    see help-steps/chroot-raw for more information.

   "$dist_source_help_steps_folder/create-local-temp-apt-repo"
   export dist_chroot_mount_resolv_conf="0"
   "$dist_source_help_steps_folder/chroot-raw"

#    if [ "$dist_build_target_arch" = "arm64" ]; then
#       ## Install package helper-scripts first so pre.bsh and initramfs-debug-enable is available.
#       pkg-install helper-scripts
#
#       ## initramfs-debug-enable is provided by package helper-scripts.
#       ## TODO: disable once arm64 build issues are resolved
#       $CHROOT initramfs-debug-enable
#    fi

   ## Install legacy-dist earlier so debconf questions are answered before
   ## meta package installation.
   pkg-install legacy-dist

   if [ "$dist_build_type_long" = "gateway" ]; then
      pkg-install whonix-gateway-packages-dependencies-pre
   elif [ "$dist_build_type_long" = "workstation" ]; then
      pkg-install whonix-workstation-packages-dependencies-pre
   elif [ "$dist_build_type_long" = "whonix-host" ]; then
      pkg-install whonix-host-packages-dependencies-pre
   elif [ "$dist_build_type_long" = "kicksecure" ]; then
      pkg-install kicksecure-packages-dependencies-pre
   else
      error "ERROR: Invalid dist_build_flavor $dist_build_flavor. Please report this bug!"
   fi

   unset dist_chroot_mount_resolv_conf
   "$dist_source_help_steps_folder/unchroot-raw"

   ## }}

   "$dist_source_help_steps_folder/create-local-temp-apt-repo"
   "$dist_source_help_steps_folder/chroot-raw"

   if echo "${BUILD_INITRAMFS_PKGS}" | grep -q dracut ; then
      true "INFO: Prevent running dracut needlessly. Will be run at the end. This is only to speed up the build."
      export INITRD=No
   fi

   ## Debugging.
   $CHROOT mount | grep /run || true
   $CHROOT ls -la /run || true
   $CHROOT ls -la /run/udev || true
   $CHROOT ls -la /run/udev/data || true

   ## Test
   ## https://piiis.blogspot.com/2013/07/fedora-dracut-in-chroot-environment.html
   $CHROOT mkdir --parents /run/udev/data || true
   $CHROOT ls -la /run/udev/data || true

   ## Reading Debian apt repository and local repository containing Whonix's packages.
   $CHROOT apt-get ${APTGETOPT[@]} $apt_sourcelist_empty $apt_sourceparts $apt_unattended_opts update

   ## Debugging.
   $CHROOT apt-get ${APTGETOPT[@]} $apt_sourcelist_empty $apt_sourceparts $apt_unattended_opts clean
   $CHROOT apt-get ${APTGETOPT[@]} $apt_sourcelist_empty $apt_sourceparts $apt_unattended_opts autoclean
   $CHROOT apt-get ${APTGETOPT[@]} $apt_sourcelist_empty $apt_sourceparts $apt_unattended_opts --fix-broken --yes install
   $CHROOT apt-get ${APTGETOPT[@]} $apt_sourcelist_empty $apt_sourceparts $apt_unattended_opts --fix-missing --yes install
   $CHROOT apt-get ${APTGETOPT[@]} $apt_sourcelist_empty $apt_sourceparts $apt_unattended_opts --fix-broken --fix-missing --yes install
   $CHROOT dpkg --configure -a
   $CHROOT dpkg --audit
   $CHROOT apt-get ${APTGETOPT[@]} $apt_sourcelist_empty $apt_sourceparts $apt_unattended_opts --yes dist-upgrade

   ## Debugging.
   $CHROOT apt-cache ${APTGETOPT[@]} $apt_sourcelist_empty $apt_sourceparts $apt_unattended_opts show nano || true
   $CHROOT apt-cache ${APTGETOPT[@]} $apt_sourcelist_empty $apt_sourceparts $apt_unattended_opts show helper-scripts || true

   if [ "$dist_build_script_skip_package_install" = "" ]; then
      true "${bold}${cyan}INFO $BASH_SOURCE: Variable dist_build_script_skip_package_install is empty. \
No packages will be excluded from installation. This information is relevant for builders using custom configurations, \
skipping packages such as Terminal-Only.${reset}"
   else
      true "${bold}${cyan}INFO $BASH_SOURCE: List of packages to be excluded from installation. This information is relevant for \
builders using custom configurations, skipping packages such as Terminal-Only. dist_build_script_skip_package_install: \
$dist_build_script_skip_package_install${reset}"
   fi

   if [ "$dist_build_install_to_root" = "1" ]; then
      true "${bold}${cyan}INFO: dist_build_install_to_root is set to 1. Skipping kernel installation (one should already be installed), ok.${reset}"
   else
      ## Need to install initramfs tool before kernel. Otherwise kernel would pull Debian's default which is initramfs-tools.
      if [ "$BUILD_INITRAMFS_PKGS" = "none" ]; then
         true "${bold}${cyan}INFO: BUILD_INITRAMFS_PKGS: ${BUILD_INITRAMFS_PKGS} - Skipping initramfs tool installation.${reset}"
      else
         true "${bold}${cyan}INFO: dist_build_install_to_root is set not set to 1. Add initramfs tool to installation list...${reset}"
         true "${bold}${cyan}INFO: BUILD_INITRAMFS_PKGS: ${BUILD_INITRAMFS_PKGS}${reset}"
         local build_header
         for build_initramfs in $BUILD_INITRAMFS_PKGS; do
            pkg-add-to-install-list "$build_initramfs"
         done
      fi
      if [ "$BUILD_KERNEL_PKGS" = "none" ]; then
         true "${bold}${cyan}INFO: BUILD_KERNEL_PKGS: ${BUILD_KERNEL_PKGS} - Skipping kernel installation.${reset}"
      else
         true "${bold}${cyan}INFO: dist_build_install_to_root is set not set to 1. Add to kernel image to installation list...${reset}"
         true "${bold}${cyan}INFO: BUILD_KERNEL_PKGS: ${BUILD_KERNEL_PKGS}${reset}"
         local build_kernel
         for build_kernel in $BUILD_KERNEL_PKGS; do
            pkg-add-to-install-list "$build_kernel"
         done
      fi
      if [ "$BUILD_HEADER_PKGS" = "none" ]; then
         true "${bold}${cyan}INFO: BUILD_HEADER_PKGS: ${BUILD_HEADER_PKGS} - Skipping kernel header installation.${reset}"
      else
         true "${bold}${cyan}INFO: dist_build_install_to_root is set not set to 1. Add kernel header to installation list...${reset}"
         true "${bold}${cyan}INFO: BUILD_HEADER_PKGS: ${BUILD_HEADER_PKGS}${reset}"
         local build_header
         for build_header in $BUILD_HEADER_PKGS; do
            pkg-add-to-install-list "$build_header"
         done
      fi
   fi

   if [ "$dist_build_flavor" != "whonix-gateway-rpi" ] && [ "$dist_build_target_arch" = "arm64" ]; then
      pkg-add-to-install-list grub2-common
      pkg-add-to-install-list grub-efi-arm64
   fi

   ## Weak recommended packages. No other package depends on it. Can be
   ## easily uninstalled. For better usability.
   if [ "$dist_build_virtualbox" = "true" ]; then
      ## See also build-steps.d/1200_create-debian-packages function
      ## download_virtualbox_packages_from_debian_sid
      pkg-add-to-install-list virtualbox-guest-utils
      pkg-add-to-install-list virtualbox-guest-x11

      ## Not required but keeping in case above packages become unavailable.
      ## Allows for higher flexibility if later switches from/to
      ## virtualbox.org repository or Debian fasttrack repository are required.
      ##
      ## https://packages.debian.org/sid/virtualbox-guest-additions-iso
      ##
      ## provides:
      ## /usr/share/virtualbox/VBoxGuestAdditions.iso
      pkg-add-to-install-list virtualbox-guest-additions-iso
   else
      true "${cyan}INFO: skipping installation of weak recommended guest additions, because not using --target virtualbox, ok.${reset}"
   fi

   ## Executing pkg-list-install already this this point for the first time to
   ## make sure linux kernel(s) and linux header(s) as well as
   ## virtualbox-guest-additions-iso get installed now so it is available
   ## during later package vm-config-dist postinst (vbox-guest-installer by
   ## derivative maintainers) without having to add `Depends:` to
   ## vm-config-dist.
   pkg-list-install

   if [ "$dist_build_raw" = "true" ]; then
      ## XXX: Superfluous for non-libvirt raw image builds.
      pkg-add-to-install-list spice-vdagent
      pkg-add-to-install-list serial-console-enable
   elif [ "$dist_build_qcow2" = "true" ]; then
      pkg-add-to-install-list spice-vdagent
      pkg-add-to-install-list serial-console-enable
   else
      true "${cyan}INFO: skipping installation of weak recommended guest additions packages spice-vdagent because not using --target qcow2, ok.${reset}"
   fi

   ## Weak recommended packages so calamares can remove them.
   if [ "$dist_build_type_long" = "whonix-host" ]; then
      pkg-add-to-install-list calamares
      pkg-add-to-install-list calamares-settings-debian

      ## contains calamares-settings-whonix
      pkg-add-to-install-list live-config-dist

      #pkg-add-to-install-list live-config

      ## https://forums.whonix.org/t/whonix-host-operating-system/3931/99
      pkg-add-to-install-list live-boot

      pkg-add-to-install-list rsync

      ## https://forums.whonix.org/t/whonix-host-operating-system/3931/107?u=patrick
      #pkg-add-to-install-list user-setup

      pkg-add-to-install-list squashfs-tools
   fi

   if [ "$flavor_meta_packages_to_install" = "none" ] || [ "$flavor_meta_packages_to_install" = "" ] || [ "$flavor_meta_packages_to_install" = " " ]; then
      true "${cyan}INFO: variable flavor_meta_packages_to_install is set to '$flavor_meta_packages_to_install', skipping.${reset}"
   else
      for flavor_meta_package_item in $flavor_meta_packages_to_install ; do
         true "${cyan}INFO: flavor_meta_packages_to_install: '$flavor_meta_packages_to_install'${reset}"
         pkg-add-to-install-list "$flavor_meta_package_item"
      done
   fi

   if [ "$install_package_list" = "none" ] || [ "$install_package_list" = "" ] || [ "$install_package_list" = " " ]; then
      true "${cyan}INFO: variable install_package_list (custom additional packages list) is set to '$install_package_list', skipping, ok.${reset}"
   else
      for install_package_item in $install_package_list ; do
         true "${cyan}INFO: install_package_item: '$install_package_item'${reset}"
         pkg-add-to-install-list "$install_package_item"
      done
   fi

   pkg-list-install

   if echo "${BUILD_INITRAMFS_PKGS}" | grep -q dracut ; then
      unset INITRD

      ## Debugging.
      $CHROOT find /usr/lib/modules -type f -name ext4.ko || true
      $CHROOT dracut --print-cmdline --fstab
      $CHROOT dracut --print-cmdline --fstab 2>&1 | tee "$dist_binary_build_folder/${VMNAME}-dracut-cmdline.txt" >/dev/null

      $CHROOT dracut \
         --force \
         --reproducible \
         --fstab \
         --add-drivers "$dist_build_file_system" \
         --verbose \
         --debug \
         2>&1 | tee "$dist_binary_build_folder/${VMNAME}-dracut-debug.txt" >/dev/null
   fi

   "$dist_source_help_steps_folder/remove-local-temp-apt-repo"
   "$dist_source_help_steps_folder/unprevent-daemons-from-starting"

   ## Forget about local repository containing Whonix's packages.
   #$CHROOT apt-get --no-download --list-cleanup update

   $CHROOT sync
   sync

   "$dist_source_help_steps_folder/unchroot-raw"
   "$dist_source_help_steps_folder/unmount-raw"

   sync
}

main() {
   if [ "$dist_build_flavor" = "whonix-custom-workstation" ]; then
      true "${cyan}INFO: Skipping installing packages for $VMNAME.${reset}"
   else
      install-packages
   fi
}

main "$@"
