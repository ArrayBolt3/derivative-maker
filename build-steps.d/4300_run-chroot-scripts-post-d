#!/bin/bash

## Copyright (C) 2012 - 2023 ENCRYPTED SUPPORT LP <adrelanos@whonix.org>
## See the file COPYING for copying conditions.

set -x
set -e

true "INFO: Currently running script: $BASH_SOURCE $@"

MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

cd "$MYDIR"
cd ..
cd help-steps

source pre
source colors
source variables

run-chroot-scripts-post-d() {
   exception_handler_setup "exception_handler_unchroot_unmount" ERR INT TERM

   $SUDO_TO_ROOT sync

   "$dist_source_help_steps_folder"/mount-raw "$@"

   "$dist_source_help_steps_folder"/prevent-daemons-from-starting "$@"

   "$dist_source_help_steps_folder"/chroot-raw "$@"

   $SUDO_TO_ROOT sync

   ## Sanity tests.
   $SUDO_TO_ROOT $CHROOT dir
   $SUDO_TO_ROOT $CHROOT mount
   $SUDO_TO_ROOT $CHROOT sync

   "$dist_source_help_steps_folder"/create-local-temp-apt-repo "$@"

   $SUDO_TO_ROOT sync

   if [ -d "$CHROOT_FOLDER/usr/libexec/initializer-dist/chroot-scripts-post.d" ]; then
      ## Check which chroot scripts we got.
      $SUDO_TO_ROOT $CHROOT run-parts --verbose --test "/usr/libexec/initializer-dist/chroot-scripts-post.d/"

      ## Run the chroot scripts.
      $SUDO_TO_ROOT $CHROOT run-parts --verbose --exit-on-error "/usr/libexec/initializer-dist/chroot-scripts-post.d/"

      sync
   else
      true "${green}${bold}INFO: Folder /usr/libexec/initializer-dist/chroot-scripts-post.d does not exist in chroot.}
Not running any chroot scripts.${reset}"
   fi

   "$dist_source_help_steps_folder"/remove-local-temp-apt-repo "$@"

   "$dist_source_help_steps_folder"/unchroot-raw "$@"

   "$dist_source_help_steps_folder"/unprevent-daemons-from-starting "$@"

   "$dist_source_help_steps_folder"/unmount-raw "$@"

   sync
}

main() {
   if [ "$dist_build_fast2" = "2" ]; then
      true "${bold}${cyan}INFO: run with '--fast 2' switch, skipping $BASH_SOURCE. ${reset}"
      exit 0
   fi

   if [ "$dist_build_type_long" = "gateway" ]; then
      run-chroot-scripts-post-d
   elif [ "$dist_build_type_long" = "workstation" ]; then
      run-chroot-scripts-post-d
   elif [ "$dist_build_type_long" = "custom-workstation" ]; then
      true "${cyan}INFO: Skipping running chroot-post.d scripts for $VMNAME.${reset}"
   elif [ "$dist_build_type_long" = "whonix-host" ]; then
      run-chroot-scripts-post-d
   elif [ "$dist_build_type_long" = "kicksecure" ]; then
      run-chroot-scripts-post-d
   else
      error "ERROR: Invalid dist_build_flavor $dist_build_flavor. Please report this bug!"
   fi
}

main "$@"
