---
- name: Register running VMs
  shell: "VBoxManage list runningvms"
  register: running_vms

- name: Shutdown gateway VM
  shell: "VBoxManage controlvm Whonix-Gateway-Xfce acpipowerbutton"
  when: "'Whonix-Gateway-Xfce' in running_vms.stdout"

- name: Shutdown workstation VM
  shell: "VBoxManage controlvm Whonix-Workstation-Xfce acpipowerbutton"
  when: "'Whonix-Workstation-Xfce' in running_vms.stdout"

- name: Pause for machine shutdown
  pause:
    minutes: 1
  when: "'Whonix-Workstation-Xfce' or 'Whonix-Workstation-Xfce' in running_vms.stdout"

- name: Register existing VMs
  shell: "VBoxManage list vms"
  register: existing_vms

- name: Delete gateway VM
  shell: "VBoxManage unregistervm Whonix-Gateway-Xfce --delete"
  when: "'Whonix-Gateway-Xfce' in existing_vms.stdout"

- name: Delete workstation VM
  shell: "VBoxManage unregistervm Whonix-Workstation-Xfce --delete"
  when: "'Whonix-Workstation-Xfce' in existing_vms.stdout"
