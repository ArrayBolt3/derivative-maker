#!/bin/bash

## Copyright (C) 2012 - 2023 ENCRYPTED SUPPORT LP <adrelanos@whonix.org>
## See the file COPYING for copying conditions.

set -x
set -e

true "INFO: Currently running script: $BASH_SOURCE $@"

MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

cd "$MYDIR"
cd ..
cd help-steps

dist_build_internal_run="true"

source pre
source colors
source variables

main() {
   sanity_tests "$@"
   gpg_key_create "$@"
   signify_key_create "$@"
   true "INFO: END of $FUNCNAME"
}

sanity_tests() {
   command -v signify-openbsd >/dev/null
}

gpg_key_create() {
   true "gpg_bin: $gpg_bin"
   ## Debugging.
   pwd

   ## Set up a separate GPG keystore.
   #export GNUPGHOME="$dist_local_signing_key_folder"

   mkdir --parents "$dist_local_signing_key_folder"
   ## chmod 700, so gpg will not complain about folder permissions
   chmod --recursive og-rwx "$dist_local_signing_key_folder"

   ## Initialize.
   $gpg_bin --fingerprint --keyid-format 0xlong  &>/dev/null

   ## http://www.gnupg.org/documentation/manuals/gnupg-devel/Unattended-GPG-key-generation.html
   ## https://github.com/ioerror/torbirdy/blob/master/gpg.conf

   if $gpg_bin --fingerprint --keyid-format 0xlong "$DEBEMAIL" &>/dev/null ; then
      true "INFO: gpg key with DEBEMAIL $DEBEMAIL already exists. Skipping."
      return 0
   fi

   true "INFO: gpg key with DEBEMAIL $DEBEMAIL does not exist yet. Generating..."

   $gpg_bin \
      --no-emit-version \
      --no-comments \
      --display-charset utf-8 \
      --personal-digest-preferences SHA512 \
      --cert-digest-algo SHA512 \
      --default-preference-list "SHA512 SHA384 SHA256 SHA224 AES256 AES192 AES CAST5 ZLIB BZIP2 ZIP Uncompressed" \
      --default-new-key-algo "ed25519/cert,sign,auth+cv25519/encr" \
      --keyserver-options no-honor-keyserver-url \
      --fixed-list-mode \
      --keyid-format 0xlong \
      --list-options show-uid-validity \
      --sig-notation issuer-fpr@notations.openpgp.fifthhorseman.net=%g \
      --batch \
      --pinentry-mode loopback \
      --passphrase '' \
      --quick-generate-key "$DEBEMAIL" default default 0

   ## Debugging.
   ## Just output list of secret keys in that very folder in case that ever breaks and someone ever sends
   ## a build log, this will help with debugging.
   $gpg_bin \
      --keyid-format 0xlong \
      --fingerprint \
      --list-secret-keys \
      "$DEBEMAIL"

   true "INFO: END of $FUNCNAME"
}

signify_key_create() {
   mkdir --parents "$signify_folder"
   chmod --recursive og-rwx "$signify_folder"

   if test -f "$signify_private_key" ; then
      true "INFO: signify_private_key $signify_private_key already exists. Skipping."
      return 0
   fi

   pushd "$signify_folder" >/dev/null
   signify-openbsd -n -G -p "$signify_public_key" -s "$signify_private_key" -c "derivative-maker"
   popd >/dev/null

   true "INFO: END of $FUNCNAME"
}

main "$@"
