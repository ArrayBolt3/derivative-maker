#!/bin/bash

## Copyright (C) 2012 - 2023 ENCRYPTED SUPPORT LP <adrelanos@whonix.org>
## See the file COPYING for copying conditions.

set -x
set -e

true "INFO: Currently running script: $BASH_SOURCE $@"

MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

source "$MYDIR/pre"
source "$MYDIR/colors"
source "$MYDIR/variables"

main() {
   ## Turning off the VM without saving.
   $SUDO_TO_VBOX_TEMP VBoxManage controlvm "$VMNAME" poweroff || true
   sync

   ## Delete old VM.
   $SUDO_TO_VBOX_TEMP VBoxManage unregistervm "$VMNAME" --delete || true
   sync

   ## The "$SUDO_TO_VBOX_TEMP VBoxManage unregistervm --delete" does not do its job,
   ## we have to manually delete the VM folder.
   $SUDO_TO_ROOT safe-rm -r -f "$HOMEVAR_VBOX_TEMP/VirtualBox VMs/$VMNAME"
   sync

   ## Delete old ova.
   $SUDO_TO_ROOT safe-rm -f "$binary_image_ova_file"
   sync
}

main "$@"
